Introduce a check mode flag `--mode` and stop requiring a main function in `lib` mode
